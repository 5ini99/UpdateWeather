# UpdateWeather

一个常驻后台的桌面天气刷新小工具，支持定时刷新天气数据，通过系统托盘控制，配备轻量级 GUI 配置界面。

## ✨ 功能特性

- 🔄 **定时刷新** - 自动定时获取天气数据，间隔可自定义（1-1440分钟）
- 🌙 **夜间模式** - 支持夜间暂停刷新，节省资源
- 🎨 **系统托盘** - 常驻系统托盘，不占用任务栏
- ⚙️ **图形化配置** - 直观的配置界面，无需手动编辑配置文件
- 🔔 **邮件通知** - 支持天气更新邮件提醒
- 🚀 **开机自启** - 可选择开机自动启动
- 💾 **配置持久化** - 配置自动保存，支持热重载

## 📦 安装

### 环境要求

- Python 3.7+
- 支持 tkinter（大多数 Python 发行版自带）

### 依赖安装

```bash
pip install -r requirements.txt
```

主要依赖：
- `pystray` - 系统托盘支持
- `Pillow` - 图像处理

## 🚀 使用方法

### 启动程序

```bash
python3 main.py
```

程序启动后会最小化到系统托盘，不显示窗口。

### 托盘菜单

右键点击系统托盘图标，可以看到以下选项：

- **立即刷新** - 立即执行一次天气数据刷新
- **设置** - 打开配置界面
- **开机自启** / **取消自启** - 切换开机自启状态
- **退出** - 退出程序

### 配置界面

点击托盘菜单的「设置」选项，会弹出配置窗口，包含以下标签页：

#### 1. 刷新设置
- **刷新间隔** - 设置自动刷新的时间间隔（分钟）
- 建议值：30-120 分钟

#### 2. 夜间模式
- **夜间暂停刷新** - 开启后在指定时间段内不刷新
- **夜间开始时间** - 暂停刷新的开始时间（0-23点）
- **夜间结束时间** - 恢复刷新的时间（0-23点）
- 示例：23:00 - 7:00

#### 3. 天气配置
- **天气 API Key** - 你的天气服务 API 密钥
- **城市 / Location** - 要查询的城市名称

#### 4. 邮件通知
- **启用邮件通知** - 开启后天气刷新完成会发送邮件

### 配置保存

修改配置后点击「保存配置」按钮，配置会立即生效，无需重启程序。

## 📁 项目结构

```
UpdateWeather/
├── main.py                 # 主入口
├── requirements.txt        # 依赖列表
├── app/
│   ├── __init__.py
│   ├── autostart.py       # 开机自启管理
│   ├── config.py          # 配置管理
│   ├── gui_process.py     # GUI 配置界面
│   ├── icon.py            # 托盘图标生成
│   ├── refresh_core.py    # 刷新核心逻辑
│   ├── refresh_impl.py    # 刷新实现
│   ├── refresh_script.py  # 刷新脚本
│   ├── scheduler.py       # 定时调度器
│   ├── state.py           # 应用状态管理
│   ├── tray.py            # 系统托盘
│   ├── tray_text.py       # 托盘文本
│   ├── tray_tooltip.py    # 托盘提示
│   └── utils.py           # 工具函数
└── legacy/                # 遗留代码
```

## ⚙️ 配置文件

配置文件位置：`~/.updateweather/config.ini`

程序首次运行会自动创建默认配置文件。

### 配置示例

```ini
[refresh]
interval_minutes = 60

[night]
skip_night = true
night_start = 23
night_end = 7

[weather]
key = your_api_key_here
location = Beijing

[mail]
enabled = true
```

## 🔧 开发说明

### 架构设计

- **主线程** - 运行系统托盘（pystray 要求）
- **后台线程** - 运行定时调度器
- **独立进程** - 配置 GUI 界面（避免阻塞托盘）

### 关键模块

1. **config.py** - 配置管理
   - 使用 ConfigParser 读写 INI 文件
   - 提供 schema 定义和类型转换
   - 线程安全的配置读写

2. **scheduler.py** - 调度器
   - 定时刷新逻辑
   - 夜间模式支持
   - 配置热重载

3. **gui_process.py** - GUI 界面
   - 基于 tkinter 的配置界面
   - 单实例管理（防止重复打开）
   - macOS 窗口激活支持

4. **state.py** - 状态管理
   - 线程安全的状态存储
   - 刷新时间管理
   - 配置变更标志

## 🐛 故障排查

### 配置窗口无法打开

```bash
# 删除锁文件重试
rm ~/.updateweather/gui.lock
```

### 配置修改不生效

- 检查是否点击了「保存配置」按钮
- 查看 `~/.updateweather/config.ini` 是否已更新
- 等待 30 秒（调度器检查间隔）

### 托盘图标不显示

- 确认系统支持托盘图标
- 检查是否有其他程序占用

### 依赖问题

```bash
# 重新安装依赖
pip install -r requirements.txt --upgrade

# 测试 tkinter
python3 -m tkinter
```

## 📝 更新日志

### v2.0.0 (2025-02-10)

- ✨ 新增完整的图形化配置界面
- ✨ 支持配置热重载（无需重启）
- ✨ 改进调度器逻辑
- 🐛 修复配置界面无法使用的问题
- 🎨 优化界面布局和交互

### v1.0.0

- ✨ 基础功能实现
- ✨ 系统托盘支持
- ✨ 定时刷新
- ✨ 夜间模式

## 📄 许可证

MIT License

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📧 联系方式

如有问题或建议，欢迎通过 Issue 反馈。

---

**享受天气刷新的便利！** 🌤️
